#!/usr/bin/env bash
set -euo pipefail

PASSED=false; trap '
    ec=$?; $PASSED || die $ec "FAILED (exitcode=$ec)"
' 0

die()  { local ec=$1; shift; echo 1>&2 "$@"; exit $ec; }

PROJDIR=$(cd "$(dirname "$0")/.." && pwd -P)

export HOME="$PROJDIR/.build/tscript/$(basename "$0")/home"
rm -rf "$HOME"; mkdir -p "$HOME"
export LOGNAME=dh_test
export DH_BOOTSTRAP_USERS="file://$PROJDIR/dh/bootstrap-users"
$PROJDIR/bootstrap-user

expected=',inb4  _inb4  cpd  dot-home'
  actual="$(LC_COLLATE=C ls -C $HOME/.home)"
[[ $expected == $actual ]] || die 30 "Failure:
  Expected: $expected
    Actual: $actual
"

expected='This file was generated by inb4'
grep -q "$expected" $HOME/.bashrc || die 40 "Failure:
  Expected: $expected
        In: $HOME/.bashrc
"

PASSED=true; echo OK
